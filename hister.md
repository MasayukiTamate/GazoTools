# 変更履歴 (History)

## 2026/01/04
- **機能追加**: 画像表示ウィンドウ（`GazoPicture`）の右クリックメニューに「登録フォルダに移動」を追加しました。
    - `GazoToolsLogic.py`:
        - `GazoPicture` クラスに `set_move_callback` メソッドを追加し、外部から移動ロジックを注入できるように修正。
        - `Drawing` メソッド内の右クリックメニュー生成処理 (`open_tag_menu`) を拡張し、登録フォルダへの移動サブメニューを追加。
    - `GazoToolsApp.py`:
        - `execute_move` 関数を `GazoControl` にコールバックとして登録する処理を追加。
- **機能追加**: 「スマート移動機能（類似画像同時移動）」を実装しました。
    - 画像右クリック「登録フォルダに移動」から、類似度に基づいて複数の画像をまとめて移動できるようになりました。
    - 類似度範囲をスライダーで直感的に調整可能です。
    - 類似度範囲をスライダーで直感的に調整可能です。
    - **改善**: スマート移動後のUI更新漏れを修正し、操作後のファイル一覧が正しく同期されるようにしました。また、類似度閾値を設定として保存するようにしました。
    - **機能追加**: アプリ起動時に「スプラッシュスクリーン（タイトル画面）」を表示するようにしました。Tips表示のON/OFFも設定可能です。
    - **機能強化**: スマート移動画面にサムネイル画像を表示するようにしました（設定でON/OFF可）。また、初期読み込みを非同期化し、スライダー操作時のリアルタイムフィルタリングを高速化しました。
    - **バグ修正**: スマート移動実行時に基準画像が先に移動されると、ウィンドウが閉じてしまい処理が中断する問題を修正しました（基準画像を最後に移動するように変更）。
    - **バグ修正**: アプリ再起動時に「最後に開いていたフォルダ」が正しく復元されない問題を修正しました（フォルダ移動時に現在の場所を正しく保存するように変更）。
    - **コード分析**: プロジェクト全体のコード分析を実施しました（詳細は `code_analysis.md` を参照）。
        - `GazoToolsLogic.py` にGUIコンポーネントが混在している問題を特定（MVC違反）。
        - `GazoToolsApp.py` の巨大な関数の複雑性を指摘。
        - 再帰的なファイル収集処理のフリーズリスクを指摘。
    - **バグ修正**: 画像サイズ設定変更時に発生していたエラー（`AttributeError`）を修正しました（`AppState`クラスへのメソッド実装漏れを解消）。
    - **バグ修正**: アプリ終了時に設定（最後に開いていたフォルダやウィンドウ位置）が保存されない問題を修正しました（終了処理ハンドラを追加）。
    - **改善**: スマート移動でベクトル未計算の画像が含まれている場合、閾値を下げても候補に出ない問題を修正（オンデマンドで計算・保存するように変更）。
    - **機能追加**: 右クリックメニューに「類似画像を探す」を追加しました（スマート移動画面を再利用）。
    - **改善**: 画像をクリックしたタイミングで、評価ウィンドウと情報ウィンドウがその画像に連動するようにしました。
    - **修正**: AIモデルの出力次元数（576次元）と解釈ロジック（1024次元）の不整合を修正しました。これに伴い、古いベクトルデータは自動的に破棄され再計算されます。
    - **機能改善**: ベクトル情報の表示機能で、人間が理解しやすいラベル（「赤色成分」「滑らか」など）の表示に加え、**内部数値（スコア/寄与度）の表示ON/OFF** を切り替えられる設定を追加しました。
    - **バグ修正**: ベクトル表示機能の設定反映において、デフォルト値の初期化不足により解釈取得エラーが発生する問題を修正しました。
    - **デバッグ改善**: ベクトル解釈時にエラーが発生した場合、詳細なトレースバックをログに出力し、UI上にもエラーの種類を表示するように改善しました。
    - **UI改善**: ベクトル情報の表示ラベルを右クリックでコピーできるようにしました。また、エラー発生時には詳細なエラー情報をワンクリックでコピーできるボタンを表示するようにし、デバッグを容易にしました。
    - **バグ修正**: `GazoPicture` クラスに `vectors_cache` が適切に初期化されていなかったため、画像表示時に `AttributeError` が発生していた問題を修正しました。
    - **バグ修正**: 画像ウィンドウの生成処理において、`_image_hash` が割り当てられる前にベクトル解釈処理がその属性を参照しようとしていたため、`AttributeError` が発生していた問題を修正しました。
    - **UI改善**: 起動時のスプラッシュ画面（タイトル表示）のタイミングを最適化しました。重い処理（設定読み込みやAIエンジンの準備）の前に表示されるように変更し、体感速度を向上させました。
    - **機能改善**: ベクトル情報が表示されていない画像を開いた際、**自動的にリアルタイムでベクトル計算・保存を行う機能**を追加しました。
    - **機能追加**: 設定メニューに「未登録なら自動で計算する」のチェックボックスを追加しました。これをOFFにすると、未知の画像に対して勝手に計算が走るのを防げます。
    - **UI改善**: ベクトル未登録の際、表示ラベルを直接クリックすることで**手動で解析・保存を実行できる機能**を追加しました。自動計算をOFFにしていても、気になる画像だけその場で調べることが可能です。
    - **リファクタリング (Phase 1)**: `GazoToolsLogic.py` からUIコンポーネント（`ScrollableFrame`, `RowWidget`, `SimilarityMoveDialog`, `SplashWindow`）を新設した `lib/GazoToolsGUI.py` に移動しました。
        - これにより循環参照のリスクを低減し、MVCアーキテクチャへの準拠を進めました。
    - **バグ修正とリファクタリング**:
        - `GazoToolsApp.py` と `GazoToolsLogic.py` のマージ競合を解消しました。
        - `lib/GazoToolsData.py` 内の `VectorEngine` インポートによる循環参照エラーを修正（関数内インポートに変更）。
        - `GazoToolsLogic.py` 内の重複コード（設定、タグ、評価の読み書きロジック）を削除し、`lib/GazoToolsData.py` の共通ロジックを利用するようにリファクタリングしました。
        - `GazoToolsData.py` に `assigned_rating` をサポートする最新のタグ読み込みロジックを移植しました。
        - `lib/GazoToolsBasicLib.py` に不足していた `blend_color` 関数を追加しました。
        - `GazoToolsApp.py` のインポート漏れ（`SplashWindow`, `SimilarityMoveDialog`, `calculate_window_layout`, `blend_color`）を修正し、アプリが正常に起動することを確認しました。
        - **重要**: リソース監視スレッド（`_update_resource_usage`）で `RuntimeError: main thread is not in main loop` が発生していた問題を修正。UI更新処理を `root.after` を使用してメインスレッドで実行するように変更しました。
        - `GazoToolsLogic.py` で `app_state` が未定義だったエラーを修正（`get_app_state` のインポート追加）。
        - `GazoToolsLogic.py` で `get_interpreter` が未定義だったエラーを修正（インポート漏れを追加）。これによりベクトル情報の表示機能が復旧しました。
    - **機能追加**:
        - **ベクトル解析専用ウィンドウ** を実装しました。情報ウィンドウとは別に、独立したウィンドウで詳細な解析テキスト（赤色成分: 0.123... 等）を確認できます。メニューから表示/非表示を切り替え可能です。
        - **クリック連動**: 画像ウィンドウをクリックすると、その画像のベクトル解析情報が「ベクトル解析ウィンドウ」に即座に表示されるようにしました。複数の画像を開いていても、閲覧中の画像の情報にサクサク切り替えられます。
        - **手動解析ボタン**: ベクトルウィンドウに「解析開始」ボタンを追加しました。未解析の画像を表示中、このボタンを押すことですぐにAI解析を実行・保存できます。（※相対パスだとファイルが見つからないエラーが出ていたのを修正しました）
        - **状態記憶**: ベクトル解析ウィンドウの表示の有無とウィンドウ位置を、アプリ再起動時に復元するようにしました。これで毎回ウィンドウを出し直す手間が減ります。
