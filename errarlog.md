# エラー・バグ記録 (errarlog)

## 2026-01-01 22:50: 画像ウィンドウのドラッグ移動が機能しない
### 現象
タイトルバーのない画像ウィンドウ（タイル表示時など）を左ドラッグで移動させようとしても、反応がない、あるいは全てのウィンドウが同じ挙動（最後に開いたウィンドウの操作）になってしまう。

### 原因の分析
1. **クロージャによる変数捕捉のミス**: `TileWindows` などのループ内でイベントハンドラ（`start_drag`, `do_drag`）を定義した際、全てのハンドラがループの最後に代入された `win` 変数を参照してしまっていた。これにより、どのウィンドウをドラッグしても「最後に配置されたウィンドウ」を動かそうとしていた。
2. **座標計算の不安定さ**: `event.x`（ウィンドウ内相対座標）と `winfo_x`（現在のウィンドウ位置）を組み合わせた加算方式は、イベントの発生タイミングや計算誤差により、ウィンドウが震える（ジッタ）原因になりやすく、枠なし移動には不向きであった。

### 対策と修正内容
1. **変数の固定（引数渡し）**: `lambda e, w=win: ...` の形式、または引数に明示的にウィンドウオブジェクトを渡す形式に変更し、各ハンドラが自分のウィンドウを正しく認識するように修正した。
2. **絶対座標方式の導入**: マウスの画面絶対座標（`event.x_root`, `event.y_root`）を使用し、「クリックした瞬間のマウスと窓の距離」を保持して移動させる方式に変更。これにより、非常に滑らかで正確な移動が可能になった。

### 教訓
ループ内でイベントバインドを行う際は、必ず変数をローカルスコープに閉じ込める（`w=win` など）こと。また、枠なしウィンドウの移動には `x_root` 系統の絶対座標を使うのが鉄則である。

## 2026-01-01 23:00: 大量の画像を開くとメモリ消費が累積する（メモリリーク）
### 現象
数多くの画像を閲覧・整列（タイル表示）し続けると、使用メモリが際限なく増大し、動作が重くなる、あるいは動作が不安定になる。

### 原因の分析
1. **リソースの明示的解放不足**: `PIL.Image.open` で開いた画像オブジェクトが正常に閉じられておらず、ガベージコレクション（GC）が走るまでファイルハンドルやメモリが保持され続けていた。
2. **一時オブジェクトの蓄積**: リサイズ後の画像（`img_resized`）や `active_config` での参照が不適切に残っており、メモリを圧迫していた。

### 対策と修正内容
1. **`with` 構文の徹底**: 全ての `Image.open` に `with` 構文を採用し、処理終了と同時に即座にリソースを解放するようにした。
2. **明示的な破棄 (`del`)**: `PhotoImage` に変換した後の不要なイメージオブジェクトに対し、`del` を呼び出してPythonのメモリ管理に早期解放を促すようにした。

### 教訓
PythonのGCを過信せず、特に画像のような重いバイナリデータを扱う際は「使い終わったら即座に棄てる」習慣を徹底することなのじゃ。ポンコツでした。
